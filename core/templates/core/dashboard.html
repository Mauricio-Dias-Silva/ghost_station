<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GHOST STATION // ULTIMATE</title>
    <style>
        /* --- ESTÉTICA GLOBAL --- */
        :root { --primary: #00ff41; --alert: #ff003c; --bg: #050505; --panel: #0a0a0a; --grid: #1a1a1a; }
        body { background-color: var(--bg); color: var(--primary); font-family: 'Consolas', monospace; margin: 0; padding: 0; overflow-x: hidden; background-image: linear-gradient(var(--grid) 1px, transparent 1px), linear-gradient(90deg, var(--grid) 1px, transparent 1px); background-size: 40px 40px; }
        .crt-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); background-size: 100% 2px, 3px 100%; pointer-events: none; z-index: 999; }

        /* GRID LAYOUT */
        .dashboard { display: grid; grid-template-columns: 320px 1fr 300px; grid-template-rows: 60px 1fr 100px; gap: 10px; height: 100vh; padding: 10px; box-sizing: border-box; }
        .panel { background: rgba(10, 10, 10, 0.9); border: 1px solid #333; padding: 10px; position: relative; box-shadow: 0 0 10px rgba(0, 255, 65, 0.05); display: flex; flex-direction: column; }
        .panel::before { content: ''; position: absolute; top: -1px; left: -1px; width: 10px; height: 10px; border-top: 2px solid var(--primary); border-left: 2px solid var(--primary); }
        .panel::after { content: ''; position: absolute; bottom: -1px; right: -1px; width: 10px; height: 10px; border-bottom: 2px solid var(--primary); border-right: 2px solid var(--primary); }

        h2 { margin: 0 0 10px 0; font-size: 12px; letter-spacing: 2px; border-bottom: 1px solid #333; padding-bottom: 5px; color: #888; }
        h3 { margin: 15px 0 5px 0; font-size: 10px; color: var(--primary); border-left: 3px solid var(--primary); padding-left: 5px; }

        /* HEADER */
        .header { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); }
        .logo { font-size: 24px; font-weight: bold; text-shadow: 0 0 5px var(--primary); }

        /* COLUNA ESQUERDA */
        .col-left { grid-column: 1; grid-row: 2 / -1; gap: 5px; overflow-y: auto; }
        canvas#visualizer { width: 100%; height: 60px; background: #000; border: 1px solid #222; }
        .radar-wrapper { display: flex; align-items: center; justify-content: space-between; border: 1px solid #222; padding: 5px; background: #000; }
        .radar-box { width: 80px; height: 80px; border-radius: 50%; border: 1px dashed #333; position: relative; }
        .radar-line { position: absolute; top: 50%; left: 50%; width: 50%; height: 2px; background: var(--primary); transform-origin: 0% 0%; }
        
        /* CONTROLES */
        label { font-size: 9px; color: #aaa; display: flex; justify-content: space-between; }
        input[type=range] { width: 100%; accent-color: var(--primary); margin: 2px 0; cursor: pointer; height: 5px; }
        .btn-main { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 8px; width: 100%; cursor: pointer; margin-top: 5px; font-family: inherit; font-size: 11px; transition: 0.2s; }
        .btn-main:hover { background: var(--primary); color: #000; box-shadow: 0 0 10px var(--primary); }
        .btn-danger { border-color: var(--alert); color: var(--alert); }
        .btn-danger:hover { background: var(--alert); color: white; }

        /* VÍDEO */
        .col-center { grid-column: 2; grid-row: 2; }
        .video-container { flex-grow: 1; background: #000; border: 2px solid #333; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; height: 100%; }
        .video-feed { width: 100%; height: 100%; object-fit: contain; }
        .video-hud { position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px; border: 1px solid rgba(0, 255, 65, 0.3); pointer-events: none; }
        .rec-dot { position: absolute; top: 10px; right: 10px; width: 10px; height: 10px; background: red; border-radius: 50%; animation: blink 1s infinite; }
        .crosshair { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; border: 1px solid rgba(0, 255, 65, 0.5); transform: translate(-50%, -50%); }
        .crosshair::before { content: ''; position: absolute; background: var(--primary); top: 19px; left: 0; width: 40px; height: 1px; }
        .crosshair::after { content: ''; position: absolute; background: var(--primary); top: 0; left: 19px; width: 1px; height: 40px; }

        /* DIREITA */
        .col-right { grid-column: 3; grid-row: 2 / -1; gap: 10px; }
        .log-terminal { flex-grow: 1; font-size: 10px; color: #aaa; overflow-y: scroll; border-top: 1px solid #333; font-family: monospace; height: 150px; }
        .log-entry { margin-bottom: 2px; border-bottom: 1px solid #111; }
        .thumb-grid { flex-grow: 1; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 2px; }
        .thumb-grid img { width: 100%; opacity: 0.7; border: 1px solid #333; }

        /* FOOTER */
        .footer { grid-column: 2; grid-row: 3; display: flex; gap: 10px; padding-top: 5px; }
        .stat-box { flex: 1; border: 1px solid #333; padding: 5px; text-align: center; display: flex; flex-direction: column; justify-content: center; }
        .val-big { font-size: 20px; font-weight: bold; }
        .val-label { font-size: 10px; color: #666; }

        @keyframes blink { 50% {opacity: 0;} }
        @media (max-width: 900px) { .dashboard { grid-template-columns: 1fr; grid-template-rows: auto; height: auto; display: flex; flex-direction: column; } }
    </style>
</head>
<body>

    <div class="crt-overlay"></div>

    <div class="dashboard">
        
        <div class="panel header">
            <div class="logo">GHOST_STATION <span style="font-size: 12px; opacity: 0.7;">// ULTIMATE</span></div>
            <div class="clock" id="sysClock">00:00:00</div>
        </div>

        <div class="panel col-left">
            <h2>MÓDULO DE ENTRADA</h2>
            <canvas id="visualizer"></canvas>
            <div class="control-group">
                <label>GANHO DE ESCUTA <span id="volDisp">50%</span></label>
                <input type="range" id="volControl" min="0" max="1" step="0.1" value="0.5" oninput="updateUI()">
            </div>
            <button class="btn-main" onclick="startRemoteAudio()">▷ CONECTAR ÁUDIO IP</button>

            <h3>CAMPO MAGNÉTICO</h3>
            <div class="radar-wrapper">
                <div class="radar-box"><div class="radar-line" id="radarNeedle"></div></div>
                <div class="mag-data">
                    <div id="magHeading">0°</div>
                    <div style="font-size: 10px; color: #555;">DELTA: <span id="magDelta" style="color: var(--primary)">0</span></div>
                </div>
            </div>

            <h3>SPIRIT BOX (EVP)</h3>
            <div class="control-group">
                <label>VELOCIDADE (SCAN) <span id="scanDisp">200ms</span></label>
                <input type="range" id="sbRate" min="50" max="1000" step="10" value="200" oninput="updateUI()">
            </div>
            <div class="control-group">
                <label>REVERB (ECO) <span id="echoDisp">30%</span></label>
                <input type="range" id="sbEcho" min="0" max="0.8" step="0.1" value="0.3" oninput="updateUI()">
            </div>
            <button class="btn-main btn-danger" id="btnSB" onclick="toggleSpiritBox()">⚡ ATIVAR VARREDURA</button>
        </div>

        <div class="panel col-center">
            <h2>VISÃO ESPECTRAL [IP_CAM]</h2>
            <div class="video-container">
                <img src="{% url 'video_feed' %}" class="video-feed">
                <div class="video-hud">
                    <div class="rec-dot"></div>
                    <div class="crosshair"></div>
                    <div style="position: absolute; bottom: 5px; left: 5px; font-size: 10px;">RES: 640x480 | FPS: 30</div>
                </div>
            </div>
        </div>

        <div class="footer">
            <div class="stat-box">
                <span class="val-label">STATUS</span>
                <span style="color: var(--primary);" id="statusSys">ONLINE</span>
            </div>
            <div class="stat-box">
                <span class="val-label">ENERGIA AMBIENTE</span>
                <span id="currEnergy" class="val-big">0.0</span>
            </div>
            <div class="stat-box">
                <span class="val-label">DISPAROS</span>
                <span id="triggerCount" class="val-big">0</span>
            </div>
        </div>

        <div class="panel col-right">
            <h2>LOG DO SISTEMA</h2>
            <div class="log-terminal" id="terminal">
                <div class="log-entry">> Sistema iniciado...</div>
            </div>
            
            <div class="panel" style="margin-top: 5px; border-color: var(--primary); text-align: center; min-height: 80px;">
                <h3 style="margin:0; border:none;">DECODIFICADOR</h3>
                <div id="wordDisplay" style="font-size: 24px; font-weight: bold; color: #fff; padding: 10px; text-shadow: 0 0 10px var(--primary);">...</div>
                <div style="font-size: 9px; color: #555;">VARIAÇÃO DE ENTROPIA</div>
            </div>

            <h2>EVIDÊNCIAS</h2>
            <div class="thumb-grid">
                {% for ev in evidencias %}
                    <a href="{{ ev.imagem_url }}" target="_blank"><img src="{{ ev.imagem_url }}"></a>
                {% empty %}
                    <div style="padding:10px; text-align:center; font-size:10px;">Aguardando dados...</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <audio id="remoteAudio" crossorigin="anonymous"></audio>

    <script>
        // --- CONFIGURAÇÃO IP ---
        const REMOTE_IP_URL = "http://10.93.175.172:8080/audio.wav"; 

        // --- BANCO DE PALAVRAS (OVILUS) ---
        const WORD_BANK = [
            "OLÁ", "AJUDA", "AQUI", "MEDO", "LUZ", "ESCURO", "MORTE", "VIDA", "TEMPO", 
            "AGORA", "VOCÊ", "NÓS", "ELES", "SINAL", "FRIO", "QUENTE", "PARE", "VAI",
            "CASA", "CAMINHO", "PORTA", "ABRIR", "FECHAR", "VER", "OUVIR", "FALAR",
            "NOME", "MAURICIO", "DOR", "PAZ", "CORRER", "ESPERAR", "SIM", "NÃO",
            "ÁGUA", "FOGO", "TERRA", "AR", "SUBIR", "DESCER", "PERTO", "LONGE"
        ];

        let audioCtx, analyser, dataArray, source;
        let sbOscillator, sbLFO, sbGain, sbFilter, feedbackNode, delayNode;
        let isSpiritBoxOn = false;
        let baseEnergy = 0;
        let emDisparo = false;
        let triggerCount = 0;
        let lastHeading = 0;
        let lastWordTime = 0;

        setInterval(() => document.getElementById('sysClock').innerText = new Date().toLocaleTimeString(), 1000);

        function sysLog(msg, type="INFO") {
            const t = document.getElementById('terminal');
            const color = type === "ALERT" ? "red" : "#00ff41";
            t.innerHTML += `<div class="log-entry"><span style="color:${color}">[${new Date().toLocaleTimeString()}]</span> ${msg}</div>`;
            t.scrollTop = t.scrollHeight;
        }

        function updateUI() {
            document.getElementById('volDisp').innerText = Math.round(document.getElementById('volControl').value*100) + "%";
            document.getElementById('scanDisp').innerText = document.getElementById('sbRate').value + "ms";
            document.getElementById('echoDisp').innerText = Math.round(document.getElementById('sbEcho').value*100) + "%";
            
            if(document.getElementById('remoteAudio')) 
                document.getElementById('remoteAudio').volume = document.getElementById('volControl').value;

            if(isSpiritBoxOn && sbLFO && feedbackNode) {
                sbLFO.frequency.value = 1000 / document.getElementById('sbRate').value;
                feedbackNode.gain.value = document.getElementById('sbEcho').value;
            }
        }

        async function startRemoteAudio() {
            try {
                if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const audioEl = document.getElementById('remoteAudio');
                audioEl.src = REMOTE_IP_URL;
                
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 512;
                
                source = audioCtx.createMediaElementSource(audioEl);
                source.connect(analyser);
                analyser.connect(audioCtx.destination);
                
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                
                await audioEl.play();
                sysLog("Áudio Remoto Conectado.", "INFO");
                document.getElementById('statusSys').innerText = "VIGILÂNCIA ATIVA";
                
                requestAnimationFrame(loopVisualizer); // INICIA O LOOP AQUI

                if (window.DeviceOrientationEvent) {
                    window.addEventListener('deviceorientation', handleMag);
                    sysLog("Magnetômetro Ativo.", "INFO");
                }
            } catch (e) { sysLog("Erro Áudio: " + e, "ALERT"); }
        }

        function loopVisualizer() {
            analyser.getByteTimeDomainData(dataArray);
            const canvas = document.getElementById('visualizer');
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width, canvas.height);
            ctx.lineWidth = 2; ctx.strokeStyle = '#00ff41'; ctx.beginPath();
            
            let sliceWidth = canvas.width * 1.0 / dataArray.length;
            let x = 0, sum = 0;
            for(let i=0; i<dataArray.length; i++) {
                let v = dataArray[i] / 128.0;
                let y = v * canvas.height/2;
                if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                x+=sliceWidth;
                sum += Math.abs(dataArray[i]-128);
            }
            ctx.stroke();
            
            let avg = sum/dataArray.length;
            document.getElementById('currEnergy').innerText = avg.toFixed(1);
            
            // 1. CHECA GATILHO DE ALERTA
            if (audioCtx.currentTime < 5) baseEnergy = (baseEnergy + avg)/2;
            else if (avg > baseEnergy * 2.0) dispararDjango(avg, 0, 'REMOTE_AUDIO');

            // 2. CHECA SE DEVE MOSTRAR PALAVRA (OVILUS)
            // Adicionei a chamada da função aqui dentro do loop
            tryManifestWord(avg);
            
            requestAnimationFrame(loopVisualizer);
        }

        function tryManifestWord(energyLevel) {
            const now = Date.now();
            if (now - lastWordTime < 3000) return; // Delay de 3s

            // Só mostra palavra se houver pico de energia significativo
            if (energyLevel > 20) { 
                const seed = Math.floor(energyLevel * 100) + Math.floor(Math.random() * 100);
                const index = seed % WORD_BANK.length;
                const chosenWord = WORD_BANK[index];
                
                const display = document.getElementById('wordDisplay');
                display.innerText = chosenWord;
                display.style.color = "#fff";
                display.style.textShadow = "0 0 20px red";
                
                sysLog(`DECODIFICADO: [${chosenWord}]`, "ALERT");
                
                setTimeout(() => {
                    display.style.color = "var(--primary)";
                    display.style.textShadow = "none";
                }, 2000);
                lastWordTime = now;
            }
        }

        function toggleSpiritBox() {
            if(!audioCtx) { alert("Conecte o áudio primeiro!"); return; }
            if(isSpiritBoxOn) {
                sbOscillator.stop(); sbLFO.stop(); isSpiritBoxOn = false;
                document.getElementById('btnSB').innerText = "⚡ ATIVAR VARREDURA";
                document.getElementById('btnSB').style.background = "transparent";
                sysLog("Spirit Box Desativada.");
            } else {
                const bufferSize = audioCtx.sampleRate * 2;
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                
                const noise = audioCtx.createBufferSource(); noise.buffer = buffer; noise.loop = true;
                sbFilter = audioCtx.createBiquadFilter(); sbFilter.type = 'bandpass'; sbFilter.Q.value = 1;
                sbLFO = audioCtx.createOscillator(); sbLFO.type = 'sawtooth';
                sbLFO.frequency.value = 1000 / document.getElementById('sbRate').value;
                const lfoGain = audioCtx.createGain(); lfoGain.gain.value = 1000;
                sbLFO.connect(lfoGain); lfoGain.connect(sbFilter.frequency);
                delayNode = audioCtx.createDelay(); delayNode.delayTime.value = 0.3;
                feedbackNode = audioCtx.createGain(); feedbackNode.gain.value = document.getElementById('sbEcho').value;
                noise.connect(sbFilter); sbFilter.connect(delayNode); delayNode.connect(feedbackNode);
                feedbackNode.connect(delayNode); delayNode.connect(audioCtx.destination); sbFilter.connect(audioCtx.destination);
                noise.start(); sbLFO.start(); sbOscillator = noise;
                isSpiritBoxOn = true;
                document.getElementById('btnSB').innerText = "PARAR VARREDURA";
                document.getElementById('btnSB').style.background = "red";
                document.getElementById('btnSB').style.color = "white";
                sysLog("Spirit Box INICIADA.", "ALERT");
            }
        }

        function handleMag(e) {
            let heading = e.alpha; if(!heading) return;
            document.getElementById('radarNeedle').style.transform = `rotate(${heading}deg)`;
            document.getElementById('magHeading').innerText = heading.toFixed(0) + "°";
            let delta = Math.abs(heading - lastHeading);
            if(delta > 180) delta = 360 - delta;
            document.getElementById('magDelta').innerText = delta.toFixed(1);
            if(delta > 15) {
                dispararDjango(0, delta, 'MAGNETICO');
                tryManifestWord(50); // Magnetismo alto também gera palavra!
            }
            lastHeading = heading;
        }

        function dispararDjango(val, mag, origem) {
            if(emDisparo) return;
            emDisparo = true;
            triggerCount++;
            document.getElementById('triggerCount').innerText = triggerCount;
            sysLog(`GATILHO: ${origem}`, "ALERT");
            document.body.style.background = "#220000";
            fetch('/api/gatilho_anomalia/', {
                method: 'POST',
                body: JSON.stringify({ audio_level: val, magnetic_delta: mag, origem_disparo: origem })
            }).then(r=>r.json()).then(d=>{
                if(d.status==='capturado') {
                    sysLog("Evidência SALVA. ID: " + d.url.split('_').pop(), "INFO");
                    setTimeout(()=>window.location.reload(), 2500);
                }
            });
            setTimeout(()=>{ emDisparo=false; document.body.style.background=""; }, 3000);
        }
    </script>
</body>
</html>