<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SPECTRAL SCANNER v3.0</title>
    <style>
        :root {
            --primary: #00ff41;
            --cyan: #00f0ff;
            --alert: #ff003c;
            --purple: #a855f7;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: #000;
            overflow: hidden;
            font-family: 'Courier New', monospace;
            touch-action: none;
        }

        video {
            display: none;
        }

        canvas {
            width: 100vw;
            height: 100vh;
            object-fit: cover;
        }

        /* HUD */
        .hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .hud-shadow {
            box-shadow: inset 0 0 60px rgba(0, 255, 255, 0.15);
        }

        .reticle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 60px;
            height: 60px;
            border: 2px solid rgba(0, 255, 255, 0.4);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: border-color 0.3s;
        }

        .reticle::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 4px;
            background: red;
            transform: translate(-50%, -50%);
            border-radius: 50%;
        }

        .reticle.active {
            border-color: var(--alert);
            box-shadow: 0 0 15px var(--alert);
        }

        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: rgba(0, 255, 65, 0.4);
            animation: scan 3s linear infinite;
        }

        /* TOP BAR */
        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 10px 15px;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.7) 0%, transparent 100%);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: none;
            z-index: 10;
        }

        .top-bar * {
            pointer-events: all;
        }

        .mode-label {
            font-size: 12px;
            color: var(--cyan);
            font-weight: bold;
            text-shadow: 0 0 5px var(--cyan);
        }

        .clock-mini {
            font-size: 10px;
            color: #aaa;
        }

        /* BOTTOM BAR */
        .bottom-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 10px 15px 20px;
            background: linear-gradient(0deg, rgba(0, 0, 0, 0.8) 0%, transparent 100%);
            z-index: 10;
        }

        .readings {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        .reading {
            text-align: center;
        }

        .reading .val {
            font-size: 16px;
            font-weight: bold;
            color: var(--primary);
            text-shadow: 0 0 5px var(--primary);
        }

        .reading .lbl {
            font-size: 8px;
            color: #777;
        }

        /* FILTER BUTTONS */
        .filter-row {
            display: flex;
            gap: 5px;
            justify-content: center;
            overflow-x: auto;
            padding: 5px 0;
        }

        .btn-filter {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #555;
            color: #aaa;
            padding: 6px 12px;
            border-radius: 15px;
            font-family: inherit;
            font-size: 9px;
            cursor: pointer;
            transition: 0.2s;
            white-space: nowrap;
        }

        .btn-filter.active {
            border-color: var(--cyan);
            color: var(--cyan);
            background: rgba(0, 240, 255, 0.1);
        }

        .btn-filter:active {
            transform: scale(0.95);
        }

        /* START BUTTON */
        .btn-start {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 40px;
            background: rgba(0, 20, 0, 0.9);
            border: 2px solid var(--primary);
            color: var(--primary);
            font-size: 18px;
            font-family: inherit;
            cursor: pointer;
            z-index: 100;
            text-shadow: 0 0 5px var(--primary);
            animation: pulseBtn 2s ease infinite;
        }

        .btn-start:active {
            background: var(--primary);
            color: #000;
        }

        /* ALERT FLASH */
        .alert-flash {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--alert);
            font-size: 14px;
            font-weight: bold;
            text-shadow: 0 0 10px var(--alert);
            display: none;
            z-index: 20;
        }

        @keyframes scan {
            0% {
                top: 0%;
            }

            100% {
                top: 100%;
            }
        }

        @keyframes pulseBtn {

            0%,
            100% {
                box-shadow: 0 0 5px var(--primary);
            }

            50% {
                box-shadow: 0 0 20px var(--primary);
            }
        }
    </style>
</head>

<body>

    <button class="btn-start" id="btnStart" onclick="iniciarSistema()">‚ö° ATIVAR ESPECTR√îMETRO</button>

    <video id="video" playsinline autoplay></video>
    <canvas id="output"></canvas>

    <div class="hud hud-shadow">
        <div class="scan-line"></div>
        <div class="reticle" id="reticle"></div>
        <div class="alert-flash" id="alertFlash">‚ö† ANOMALIA ‚ö†</div>
    </div>

    <div class="top-bar">
        <div>
            <div class="mode-label" id="modeLabel">GHOST_VISION</div>
            <div class="clock-mini" id="miniClock">--:--:--</div>
        </div>
        <a href="/"
            style="color:var(--primary); font-size:10px; text-decoration:none; border:1px solid var(--primary); padding:3px 8px; border-radius:10px;">‚Üê
            DASHBOARD</a>
    </div>

    <div class="bottom-bar">
        <div class="readings">
            <div class="reading">
                <div class="val" id="valEmf">0.0</div>
                <div class="lbl">EMF (ŒºT)</div>
            </div>
            <div class="reading">
                <div class="val" id="valSpec">0.0</div>
                <div class="lbl">SPEC (%)</div>
            </div>
            <div class="reading">
                <div class="val" id="valFreq" style="color:var(--cyan)">---</div>
                <div class="lbl">FREQ (Hz)</div>
            </div>
            <div class="reading">
                <div class="val" id="valScore" style="color:var(--alert)">0</div>
                <div class="lbl">ALERTS</div>
            </div>
        </div>
        <div class="filter-row" id="filterRow">
            <button class="btn-filter active" data-mode="ghost" onclick="setMode('ghost', this)">üëª ECTOPLASMA</button>
            <button class="btn-filter" data-mode="thermal" onclick="setMode('thermal', this)">üî• THERMAL</button>
            <button class="btn-filter" data-mode="uv" onclick="setMode('uv', this)">üîÆ UV LIGHT</button>
            <button class="btn-filter" data-mode="night" onclick="setMode('night', this)">üåô NIGHT VISION</button>
            <button class="btn-filter" data-mode="edge" onclick="setMode('edge', this)">‚ö° EDGE DETECT</button>
        </div>
    </div>

    <script>
        let video, canvas, ctx, width, height;
        let lastFrameData = null;
        let audioCtx, osc, gainNode;
        let isRunning = false;
        let currentMode = 'ghost';
        let hueShift = 0;
        let alertCount = 0;

        setInterval(() => document.getElementById('miniClock').innerText = new Date().toLocaleTimeString(), 1000);

        function setMode(mode, btn) {
            currentMode = mode;
            document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const labels = { ghost: 'GHOST_VISION', thermal: 'THERMAL_CAM', uv: 'UV_SPECTRUM', night: 'NIGHT_VISION', edge: 'EDGE_DETECT' };
            document.getElementById('modeLabel').innerText = labels[mode] || mode.toUpperCase();
        }

        async function iniciarSistema() {
            document.getElementById('btnStart').style.display = 'none';

            // Audio Engine
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            osc = audioCtx.createOscillator();
            gainNode = audioCtx.createGain();
            osc.type = 'sawtooth'; osc.frequency.value = 50; gainNode.gain.value = 0;
            osc.connect(gainNode); gainNode.connect(audioCtx.destination); osc.start();

            // Camera
            video = document.getElementById('video');
            canvas = document.getElementById('output');
            ctx = canvas.getContext('2d', { willReadFrequently: true });

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } },
                    audio: false
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    width = canvas.width = video.videoWidth;
                    height = canvas.height = video.videoHeight;
                    isRunning = true;
                    requestAnimationFrame(processarFrame);
                };
            } catch (e) { alert("Erro C√¢mera: " + e); }

            // Magnetometer
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', (e) => {
                    if (e.alpha !== null) {
                        document.getElementById('valEmf').innerText = Math.abs(e.alpha).toFixed(1);
                        hueShift = e.alpha;
                    }
                });
            }
        }

        function processarFrame() {
            if (!isRunning) return;
            ctx.drawImage(video, 0, 0, width, height);
            const frameData = ctx.getImageData(0, 0, width, height);
            const data = frameData.data;
            const length = data.length;
            let totalMovement = 0;

            if (!lastFrameData) {
                lastFrameData = new Uint8ClampedArray(data);
                requestAnimationFrame(processarFrame);
                return;
            }

            // === PROCESS BASED ON MODE ===
            for (let i = 0; i < length; i += 4) {
                const rDiff = Math.abs(data[i] - lastFrameData[i]);
                const gDiff = Math.abs(data[i + 1] - lastFrameData[i + 1]);
                const bDiff = Math.abs(data[i + 2] - lastFrameData[i + 2]);
                const movement = rDiff + gDiff + bDiff;

                switch (currentMode) {
                    case 'ghost': // Ectoplasma (original)
                        if (movement > 30) {
                            data[i] = 0; data[i + 1] = 255; data[i + 2] = 255;
                            totalMovement += movement;
                        } else {
                            data[i] *= 0.1; data[i + 1] *= 0.15; data[i + 2] *= 0.1;
                        }
                        break;

                    case 'thermal': // Mapa de calor
                        const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
                        if (movement > 20) {
                            data[i] = Math.min(255, brightness + movement); // R
                            data[i + 1] = Math.max(0, 128 - movement); // G
                            data[i + 2] = 0; // B
                            totalMovement += movement;
                        } else {
                            const temp = brightness / 255;
                            data[i] = temp * 100; data[i + 1] = 0; data[i + 2] = temp * 200;
                        }
                        break;

                    case 'uv': // Ultravioleta
                        if (movement > 25) {
                            data[i] = 180; data[i + 1] = 0; data[i + 2] = 255;
                            totalMovement += movement;
                        } else {
                            data[i] *= 0.3; data[i + 1] *= 0.05; data[i + 2] *= 0.5;
                        }
                        break;

                    case 'night': // Night Vision (verde intenso)
                        const luma = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                        const boost = movement > 15 ? 1.5 : 1.0;
                        if (movement > 15) totalMovement += movement;
                        data[i] = 0;
                        data[i + 1] = Math.min(255, luma * boost * 1.3);
                        data[i + 2] = 0;
                        break;

                    case 'edge': // Edge detection
                        if (movement > 20) {
                            const intensity = Math.min(255, movement * 3);
                            data[i] = intensity; data[i + 1] = intensity; data[i + 2] = intensity;
                            totalMovement += movement;
                        } else {
                            data[i] = 0; data[i + 1] = 0; data[i + 2] = 0;
                        }
                        break;
                }
            }

            ctx.putImageData(frameData, 0, 0);
            lastFrameData.set(frameData.data);

            // Activity level
            const activityLevel = totalMovement / length;
            document.getElementById('valSpec').innerText = (activityLevel * 100).toFixed(1);

            // Sonification
            if (activityLevel > 0.01) {
                const freq = 100 + (activityLevel * 5000);
                gainNode.gain.setTargetAtTime(0.25, audioCtx.currentTime, 0.1);
                osc.frequency.setTargetAtTime(freq, audioCtx.currentTime, 0.1);
                document.getElementById('valFreq').innerText = freq.toFixed(0);
                document.getElementById('reticle').classList.add('active');
            } else {
                gainNode.gain.setTargetAtTime(0, audioCtx.currentTime, 0.5);
                document.getElementById('valFreq').innerText = '---';
                document.getElementById('reticle').classList.remove('active');
            }

            // Alert threshold
            if (activityLevel > 0.05) {
                alertCount++;
                document.getElementById('valScore').innerText = alertCount;
                const af = document.getElementById('alertFlash');
                af.style.display = 'block';
                setTimeout(() => af.style.display = 'none', 800);

                // Auto-trigger to server
                if (activityLevel > 0.1) {
                    fetch('/api/gatilho_anomalia/', {
                        method: 'POST',
                        body: JSON.stringify({
                            audio_level: activityLevel * 10,
                            magnetic_delta: hueShift,
                            origem_disparo: 'MOBILE_SCANNER_' + currentMode.toUpperCase()
                        })
                    }).catch(() => { });
                }
            }

            requestAnimationFrame(processarFrame);
        }
    </script>
</body>

</html>